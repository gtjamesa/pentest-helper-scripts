#!/usr/bin/env python3

import requests
import argparse


def print_open(port):
    print(f'{port}\t: Open')


def make_request(port):
    proxies = {'http': args.proxy}
    try:
        r = requests.get(f'http://{args.host}:{port}', proxies=proxies, timeout=args.timeout)
        if r.status_code != 503:
            print(f'{port}\t: Open (HTTP {r.status_code})')
    except requests.ReadTimeout:
        print_open(port)
    except requests.ConnectionError:
        print_open(port)
        pass


def main():
    for i in range(49000, 65536):
        print(f'{i}', end='\r', flush=True)
        make_request(i)


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--timeout', default=5)
    parser.add_argument('--host', required=False,
                        default='localhost', help='Internal hostname to request')
    parser.add_argument('proxy', help='Proxy server')
    args = parser.parse_args()
    main()
