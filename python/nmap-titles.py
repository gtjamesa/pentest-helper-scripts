#!/usr/bin/env python3

import os
import sys
import re

def load_file():
    gnmap_file = sys.argv[1] if len(sys.argv) == 2 else './reports/nmap.gnmap'
    gnmap_path = os.path.join(os.getcwd(), gnmap_file)

    with open(gnmap_path) as f:
        return f.read()


def get_matches(content):
    return re.findall(r'(\d+)/(.+?)/(tcp|udp)/(.*?)/(.*?)/(.*?)/(.*?)/,?', content)


def get_service_name(service, port):
    port = int(port)

    if service == 'domain' and port == 53:
        return 'DNS'

    if 'kerberos' in service and port == 88:
        return 'Kerberos'

    if service == 'netbios-ssn' and port == 139:
        return 'SMB'

    if 'microsoft-ds' in service and port == 445:
        return 'SMB'

    if 'ldap' in service and port in [389, 636, 3268, 3269]:
        return 'LDAP'

    if 'http' in service and port in [5985, 5986]:
        return 'WinRM'

    if service == 'mysql':
        return 'MySQL'

    if service == 'ssl|http':
        return 'HTTPS'

    # We don't need titles for RPC services
    if service == 'msrpc' and port > 40000:
        return None

    return service.upper()


def print_title(m):
    service_name = get_service_name(m[4], m[0])

    if service_name == None:
        return

    print(f'### {service_name} - {m[2].upper()} {m[0]}')


def main():
    content = load_file()
    services = get_matches(content=content)

    for service in services:
        print_title(service)


if __name__ == "__main__":
    main()
