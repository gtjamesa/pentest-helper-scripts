#!/bin/bash
vpnline=""
torline=""
is_openvpn=0
is_tor=0
is_mullvad=0
# vpnip=$(ip addr | grep tun0 | grep inet | tr -s ' ' | cut -d ' ' -f 3 | cut -d "/" -f 1)

# get_vpn_ip() {
openvpnip=$(ip addr | grep -E 'tun0|tap0' | grep inet | tr -s ' ' | cut -d ' ' -f 3 | cut -d "/" -f 1)
mullvadip=$(ip addr | grep wg-mullvad | grep inet | tr -s ' ' | cut -d ' ' -f 3 | cut -d "/" -f 1)

if [[ -n $openvpnip ]]; then
   vpnip="$openvpnip"
   is_openvpn=1
   # return
fi

if [[ -n $mullvadip ]]; then
   vpnip="$mullvadip"
   is_mullvad=1
   # return
fi

# echo ""
# }

# vpnip=$(get_vpn_ip)
# echo "IP: $vpnip [$is_openvpn / $is_mullvad]"

get_tor_ip() {
   checkfile="$HOME/.config/.checkip"
   timenow=$(date +%s)
   lastchecked=""
   should_check=0

   # file exists
   if [[ -f "$checkfile" ]]; then
      lastchecked=$(cut -d'|' -f 1 <$checkfile)
   fi

   # never checked
   if [[ -z "$lastchecked" ]]; then
      should_check=1
   fi

   # echo $lastchecked
   # echo $(expr $timenow - 60)
   # echo "$lastchecked"

   if [[ $(expr $timenow - 60) -ge "$lastchecked" ]]; then
      # echo "yes"
      should_check=1
   fi

   # echo "$should_check"

   # fetch ip and save to file   
   if [[ "$should_check" -eq 1 ]]; then
      lastchecked="$timenow"
      
      if [[ "$is_tor" -eq 1 ]]; then
         torip=$(curl -sx socks5://127.0.0.1:9050 ipecho.net/plain; echo)
      else
         torip=$(curl -s ipecho.net/plain; echo)
      fi
      # echo "$lastchecked|$torip" > "$checkfile"
   fi
}

# if [[ -n $vpnip ]]; then
if [[ "$is_openvpn" -eq 1 ]]; then
   vpnfile=$(ps aux | grep -i 'sudo openvpn' | head -1 | grep -oiE 'sudo openvpn /.+?\.(ovpn|conf)' | cut -d ' ' -f 3-)
   lab=$(cat $vpnfile | grep "remote " | cut -d " " -f 2 | cut -d "." -f 1 | cut -d "-" -f 2- | head -1)
   gwip=$(ip route | grep -E 'tun0|tap0' | grep via | cut -d " " -f 3 | uniq | head -1)
   ping=''
   #ping=$(ping -c 1 $gwip -W 1 | sed '$!d;s|.*/\([0-9.]*\)/.*|\1|' | cut -c1-4)

   if [[ $ping != '' ]]; then
      vpnline="VPN: $lab ($vpnip) [$ping ms]"
   else
      vpnline="VPN: $lab ($vpnip)"
   fi
else
   vpnline="VPN: Disconnected"
   # if [[ $(systemctl is-active tor) == "active" ]]; then
   #    get_tor_ip
   #    torip="Active"

   #    # get ip from file
   #    if [[ -f "$HOME/.config/.checkip" ]]; then
   #       torip=$(cut -d'|' -f 2 "$HOME/.config/.checkip")
   #    fi

   #    echo "Tor: $torip"
   # else
   #    echo "VPN: Disconnected"
   # fi
fi

# Mullvad
if [[ "$is_mullvad" -eq 1 ]]; then
   info=$(curl -s https://am.i.mullvad.net/connected)
   lab=$(echo $info | grep -oP '\(server \K(.+?)(?=\))')
   vpnip=$(echo $info | grep -oP 'IP address is \K(.+?)$')
   vpnline="VPN: $lab ($vpnip)"
fi

# Tor
if [[ $(systemctl is-active tor) == "active" ]]; then
   get_tor_ip
   torip="Active"
   is_tor=1

   # get ip from file
   if [[ -f "$HOME/.config/.checkip" ]]; then
      torip=$(cut -d'|' -f 2 "$HOME/.config/.checkip")
   fi

   torline=" / Tor: $torip"
fi

echo "$vpnline$torline"