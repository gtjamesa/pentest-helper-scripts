#!/bin/bash

HELPERS_PATH=$(pwd | sed 's/\/\.dotfiles//')
DOTFILES_PATH="$HELPERS_PATH/.dotfiles"
CONFIG_PATH="$HOME/.config/helper-scripts"
SHARE_PATH="/usr/share"

backup_file() {
  if [[ -L $1 ]]; then
    echo "Removing symlink $1"
    rm -f "$1"
  elif [[ -f $1 ]]; then
    echo "Creating backup of $1"
    mv "$1" "$1.bak"
  fi
}

symlink_file() {
  backup_file "$2"
  ln -sf "$1" "$2"
}

install_config() {
    mkdir -p $CONFIG_PATH
    cat <<EOF > "$CONFIG_PATH/config"
#!/bin/bash

export HELPERS_PATH=$HELPERS_PATH
export DOTFILES_PATH="\$HELPERS_PATH/.dotfiles"
EOF
}

install_dotfiles() {
  # Add global gitignore
  symlink_file "$DOTFILES_PATH/shell/.global-gitignore" "$HOME/.global-gitignore"
  git config --global core.excludesfile "$HOME/.global-gitignore"

  # Add vimrc
  symlink_file "$DOTFILES_PATH/shell/.vimrc" "$HOME/.vimrc"
}

# Install ohmyzsh
# https://github.com/ohmyzsh/ohmyzsh
install_zsh() {
  echo "Installing ohmyzsh"
  echo "--------------------"
  rm -rf "$HOME/.oh-my-zsh/"
  backup_file ~/.zshrc

  # Run ohmyzsh installer
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
  
  # Install Themes
  ln  "$DOTFILES_PATH/themes/james-custom.zsh-theme" "$HOME/.oh-my-zsh/themes/"

  # Install RC file
  ln -sf "$DOTFILES_PATH/shell/.zshrc" "$HOME/.zshrc"

  echo "Installing ZSH tools"
  echo "--------------------"

  if [[ ! -d "$SHARE_PATH/zsh-autosuggestions" ]]; then
    sudo git clone https://github.com/zsh-users/zsh-autosuggestions.git "$SHARE_PATH/zsh-autosuggestions"
  fi

  if [[ ! -d "$SHARE_PATH/zsh-syntax-highlighting" ]]; then
    sudo git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "$SHARE_PATH/zsh-syntax-highlighting"
  fi
}

install_tmux() {
  echo "Installing tmux"
  echo "---------------"

  # Add tmux plugins
  mkdir -p "$HOME/.tmux/plugins"
  git clone https://github.com/tmux-plugins/tpm "$HOME/.tmux/plugins/tpm"

  # Add tmux config
  symlink_file "$DOTFILES_PATH/shell/.tmux.conf" "$HOME/.tmux.conf"
}

install_fzf() {
  echo "Installing fzf"
  echo "--------------"

  brew install fzf
  $(brew --prefix)/opt/fzf/install --key-bindings --completion --no-update-rc
}

# Install homebrew
# https://docs.brew.sh/Homebrew-on-Linux
install_homebrew() {
  rm -rf "$HOME/.linuxbrew"
  bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  if [[ "$OS" == "Linux" ]]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  fi
}

install_pipx() {
    python3 -m pip install --user pipx
    python3 -m pipx ensurepath
}

install() {
    echo "Installing .dotfiles"
    echo "--------------------"
    sudo -v

    install_config
    install_homebrew
    install_zsh
    install_dotfiles
    install_tmux
    install_fzf
    install_pipx
}

install